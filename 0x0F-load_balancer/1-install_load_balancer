#!/usr/bin/env bash
# Installs HAProxy

sudo apt-get install --no-install-recommends -y software-properties-common
sudo add-apt-repository -y ppa:vbernat/haproxy-2.8
sudo apt-get -y install haproxy=2.8.\*


#configure HAProxy
sudo mv /etc/haproxy/haproxy.cfg /etc/haproxy/haproxy.cfg.bak

# Create a new HAProxy configuration file
sudo tee -y /etc/haproxy/haproxy.cfg > /dev/null <<EOL
global
	daemon
	maxconn 256

defaults
	mode http
	timeout connect 5000ms
	timeout client 50000ms
	timeout server 50000ms

frontend web
	bind *:80
	default_backend servers

backend servers
	balance roundrobin
	server web-01 239778-web-01:80 check
	server web-02 239778-web-02:80 check
EOL

# Restart HAProxy to apply the changes
sudo systemctl restart haproxy

# Enable HAProxy to start on boot
sudo systemctl enable haproxy
